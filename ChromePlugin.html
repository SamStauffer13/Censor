<!doctype html>

<html>

<head>
    <link rel="shortcut icon" type="image/png" href="Jasmine/lib/jasmine-2.4.1/jasmine_favicon.png">
    <link rel="stylesheet" href="Jasmine/lib/jasmine-2.4.1/jasmine.css">
    <script src="Jasmine/lib/jasmine-2.4.1/jasmine.js"></script>
    <script src="Jasmine/lib/jasmine-2.4.1/jasmine-html.js"></script>
    <script src="Jasmine/lib/jasmine-2.4.1/boot.js"></script>
</head>

<body>

    <script> 
    'use strict';

    it("pressing the browser icon will open the interface");

    it("pressing the browser icon again will close the interface");

    it("interface should give adequate props to Marat for supplying the attack helicopter icon");

    it("user setting will marquee accross the page...");

    it("clicking on a user setting will populate the settings form");

    class SettingsService
    {
        constructor(SettingsDataAccess)
        {  
            this.db = SettingsDataAccess;
            this.timesInvoked = 1;

            // // todo the icon and the content script js are usually independent js files that are loaded independently via the manifest.... 
            // chrome.browserAction.onClicked.addListener(function () {
            //     chrome.tabs.query({ active: true, currentWindow: true }, function (tabs) {

            //         // chrome.tabs.sendMessage(tabs[0].id, { applySettings: "true" }, function (response) {
            //         chrome.tabs.sendMessage(tabs[0].id, { displaySettings: "true" }, function (response) {


            //         });
            //     });
            // }); 
            
            // chrome.runtime.onMessage.addListener( (request, sender, sendResponse) => { if (request.applySettings) this.ApplySettings(); });
            // chrome.runtime.onMessage.addListener( (request, sender, sendResponse) => { if (request.displaySettings) this.DisplaySettings(); });

            this.ApplySettings(); 

            // todo pass in relevant mutant nodes ( exluding our UI nodes ) instead of entire document body 
            new MutationObserver( mutations => { this.ApplySettings();  }).observe(document.body, { subtree: true, childList: true }); 
        }

        ApplySettings(domToParse = document.body)
        {
            let start = performance.now();
            
            let settings = this.db.GetSettings(), textNodeOnPage, ent = document.createTreeWalker(domToParse, NodeFilter.SHOW_TEXT);
            
            while (textNodeOnPage = ent.nextNode())
            {
                Object.keys(settings).forEach( word => { textNodeOnPage.nodeValue = textNodeOnPage.nodeValue.replace(word, settings[word]); }); 
            }

            // todo remove this once testing is complete
            console.info(`plugin took ${performance.now() - start} ms to execute on try #${this.timesInvoked++}`);            
        }

        DisplaySettings(hideMenu)
        {
            // if its already displaying on the page and this is called, then hide it

            // if it exists on the plugin, show it 

            // else get settings from db and build it
            let marquee = document.createElement("marquee");
            marquee.addEventListener("click", this.SaveSettings());

            // sets listener that would trigger save then apply
            let saveButton = document.createElement("button");
            saveButton.addEventListener("click", this.SaveSettings());
        }

        SaveSettings()
        {
            // gets settings from dom and pushes to plugin storage

            // gets from plugin storage and saves settings to db
        }
    }
    
    // integration tests are for the User, will be refactored into more concise documentation once all test are passing...
    describe("When Applying User Settings, ", function(){

        it("our plugin will replace any word on a web page with a word defined in its settings", function(){
            // arrange
            let word = 'fire ants'; 
            let definition = 'spicy boys'; // support the cause: https://goo.gl/6Rl20I
            
            let div = document.createElement("div");
            let span = document.createElement("span");

            span.innerHTML = `bla bla bla ${word} bla bla bla`;

            div.appendChild(span);
            document.body.appendChild(div);

            let fakeDataAccess = new SettingsDataAccess();            
            fakeDataAccess.GetSettings = () => { return { [word] : definition }; }
            
            // act
            let plugin = new SettingsService(fakeDataAccess);

            // assert
            expect(span.innerHTML).toEqual(`bla bla bla ${definition} bla bla bla`);

            div.remove();
        });

        it("the plugin will automatically modify ajaxed content", function(){

            // uses a mutation observer https://goo.gl/iBc25q

            // arrange (copied from above)
            let word = 'fire ants'; 
            let definition = 'spicy boys';

            let div = document.createElement("div");
            let span = document.createElement("span");

            span.innerHTML = `bla bla bla ${word} bla bla bla`;

            div.appendChild(span);
            document.body.appendChild(div);

            let fakeDataAccess = new SettingsDataAccess();            
            fakeDataAccess.GetSettings = () => { return { [word] : definition }; }
            
            // act
            let plugin = new SettingsService(fakeDataAccess);

            // BOOM the dom was changed AFTER the plugin ran...
            span.innerHTML = `bla bla bla ${word} bla bla bla`;            

            // assert todo this is either executing too quickly or we need to retrieve the dom element again...       
            expect(span.innerHTML).toEqual(`bla bla bla ${definition} bla bla bla`);        

            div.remove();
        });

        describe("the plugin will recursively utilize keywords to modify a page's contents", function () {

            it("the plugin will modify a page's contents regardless of capitolization or plurlization");

            it("English determiners will be ignored");

            it("The first word in a sequence will take presidence in aggressive mode.", function(){

                pending();
                // take the first word and the content after it, if the content after it contains the second word, replace the whole string...

            });
        });
    });    

    class SettingsDataAccess
    {
        constructor()
        {            
            this.storageKey = "WRP";
            this.defaultSettings = { "donald trump" : "mad scientist" }; 
        }

        GetSettings()
        {
            let settings = localStorage.getItem(this.storageKey);

            try
            {                
                let parsed = JSON.parse(settings); 
                if (parsed && typeof parsed === 'object') return parsed;                
            }
            catch(error)
            {
                console.warn(`${error.message} while parsing: ${settings}`);
            }

            return this.defaultSettings; 
        }

        UpdateSettings(settings)
        {
            localStorage.setItem("WRP", JSON.stringify(settings));
        }
    }

    // Unit tests are for the Developer
    describe("When using the settings data access class... ", function(){

        let sut;
        beforeEach(() => { sut = new SettingsDataAccess(); });

        it("user settings will be returned if available", function(){
            // arrange
            let expectedSettings = { "this word" : "that word" };
            localStorage.setItem("WRP", JSON.stringify(expectedSettings));
            // act 
            let actualSettings = sut.GetSettings();
            // assert
            expect(actualSettings).toEqual(expectedSettings); 
        });

        it("default settings will be returned if user settings are empty", function(){
            // arrange
            localStorage.setItem("WRP", '');
            // act 
            let result = sut.GetSettings();
            // assert
            expect(result).toEqual( {"donald trump" : "mad scientist"} ); 
        });

        it("default settings will be returned if user settings are null", function(){
            // arrange
            localStorage.setItem("WRP", null);
            // act 
            let result = sut.GetSettings();
            // assert
            expect(result).toEqual( {"donald trump" : "mad scientist"} ); 
        });

        it("default settings will be returned if user settings are invalid json", function(){
            // arrange
            localStorage.setItem("WRP", '{');
            // act 
            let result = sut.GetSettings();
            // assert
            expect(result).toEqual( {"donald trump" : "mad scientist"} ); 
        });

        it("default settings will be returned if user settings not a JSON object", function(){
            // arrange
            localStorage.setItem("WRP", 9);
            // act 
            let result = sut.GetSettings();
            // assert
            expect(result).toEqual( {"donald trump" : "mad scientist"} ); 
        });        
    });    

</script>

</body>

</html>