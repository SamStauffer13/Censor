<!doctype html>

<html>

<head>
    <link rel="shortcut icon" type="image/png" href="Jasmine/lib/jasmine-2.4.1/jasmine_favicon.png">
    <link rel="stylesheet" href="Jasmine/lib/jasmine-2.4.1/jasmine.css">
    <script src="Jasmine/lib/jasmine-2.4.1/jasmine.js"></script>
    <script src="Jasmine/lib/jasmine-2.4.1/jasmine-html.js"></script>
    <script src="Jasmine/lib/jasmine-2.4.1/boot.js"></script>
</head>

<body>

    <script> 
    'use strict';

    class SettingsService
    {
        constructor(SettingsDataAccess)
        {  
            this.db = SettingsDataAccess;
        }

        ApplySettings()
        {
            // gets settings from db and applies them            
            var settings = this.db.GetSettings();           
        }

        DisplaySettings()
        {
            // gets settings from db and displays them
            // sets listener that would trigger save then apply
        }

        SaveSettings()
        {
            // gets settings from dom and saves settings to db
        }
    }

    describe("When Applying User Settings", function(){

        let sut;
        let mockedDataAccess;
        beforeEach(() => { 
            mockedDataAccess = new SettingsDataAccess();
            sut = new SettingsService(mockedDataAccess); 
        });

        it("Should replace this with that", function(){
        // arrange
        let word = 'fire ants'; 
        let definition = 'spicy boys'; // support the cause: https://goo.gl/6Rl20I

        mockedDataAccess.GetSettings = () => { return { word : definition }; }

        let div = document.createElement("div");
        let span = document.createElement("span");

        span.innerHTML = `bla bla bla ${word} bla bla bla`;

        div.appendChild(span);
        document.body.appendChild(div);

        // act
        sut.ApplySettings();

        // assert
        expect(span.innerHTML).toEqual(`bla bla bla ${definition} bla bla bla`);

        div.remove();

        });
    });    

    class SettingsDataAccess
    {
        constructor()
        {            
            this.storageKey = "WRP";
            this.defaultSettings = { "donald trump" : "mad scientist" }; 
        }

        GetSettings()
        {
            let settings = localStorage.getItem(this.storageKey);

            try
            {                
                let parsed = JSON.parse(settings); 
                if (parsed && typeof parsed === 'object') return parsed;                
            }
            catch(error)
            {
                console.error(`${error.message} while parsing: ${settings}`);
            }

            return this.defaultSettings; 
        }

        UpdateSettings(settings)
        {
            localStorage.setItem("WRP", JSON.stringify(settings));
        }
    }

    describe("When using the settings data access class... ", function(){

        let sut;
        beforeEach(() => { sut = new SettingsDataAccess(); });

        it("user settings will be returned if available", function(){
            // arrange
            let expectedSettings = { "this word" : "that word" };
            localStorage.setItem("WRP", JSON.stringify(expectedSettings));
            // act 
            let actualSettings = sut.GetSettings();
            // assert
            expect(actualSettings).toEqual(expectedSettings); 
        });

        it("default settings will be returned if user settings are empty", function(){
            // arrange
            localStorage.setItem("WRP", '');
            // act 
            let result = sut.GetSettings();
            // assert
            expect(result).toEqual( {"donald trump" : "mad scientist"} ); 
        });

        it("default settings will be returned if user settings are null", function(){
            // arrange
            localStorage.setItem("WRP", null);
            // act 
            let result = sut.GetSettings();
            // assert
            expect(result).toEqual( {"donald trump" : "mad scientist"} ); 
        });

        it("default settings will be returned if user settings are invalid json", function(){
            // arrange
            localStorage.setItem("WRP", '{');
            // act 
            let result = sut.GetSettings();
            // assert
            expect(result).toEqual( {"donald trump" : "mad scientist"} ); 
        });

        it("default settings will be returned if user settings not a JSON object", function(){
            // arrange
            localStorage.setItem("WRP", 9);
            // act 
            let result = sut.GetSettings();
            // assert
            expect(result).toEqual( {"donald trump" : "mad scientist"} ); 
        });        
    });    

</script>

</body>

</html>