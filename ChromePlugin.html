<!doctype html>

<html>

<head>
    <link rel="shortcut icon" type="image/png" href="Jasmine/lib/jasmine-2.4.1/jasmine_favicon.png">
    <link rel="stylesheet" href="Jasmine/lib/jasmine-2.4.1/jasmine.css">
    <script src="Jasmine/lib/jasmine-2.4.1/jasmine.js"></script>
    <script src="Jasmine/lib/jasmine-2.4.1/jasmine-html.js"></script>
    <script src="Jasmine/lib/jasmine-2.4.1/boot.js"></script>
</head>

<body>

    <script> 
    'use strict';

    class SettingsService
    {
        constructor(SettingsDataAccess)
        {  
            this.db = SettingsDataAccess;
        }

        ApplySettings()
        {                        
            let start = performance.now();

            let settings = this.db.GetSettings(), element, ent = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT);
            
            while (element = ent.nextNode())
            {
                Object.keys(settings).forEach(word => { element.nodeValue = element.nodeValue.replace(word, settings[word]); }); 
            }
            
            var observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {

                    // console.log(mutation, mutation.type);                    
                });    
            });            
            
            observer.observe(document.body, { attributes: true, subtree: true, childList: true, characterData: true });

            let end = performance.now();

            console.info(`plugin took ${end - start} ms to execute`);
        }

        DisplaySettings()
        {
            // gets settings from db and displays them
            // sets listener that would trigger save then apply
        }

        SaveSettings()
        {
            // gets settings from dom and saves settings to db
        }
    }

    // integration tests, will be refactored into more concise documentation once all test are passing...
    describe("When Applying User Settings, ", function(){

        let sut, mockedDataAccess;
        beforeEach(() => { 
            mockedDataAccess = new SettingsDataAccess();
            sut = new SettingsService(mockedDataAccess); 
        });

        it("our plugin will replace any word on a web page with a word defined in its settings", function(){
            // arrange
            let word = 'fire ants'; 
            let definition = 'spicy boys'; // support the cause: https://goo.gl/6Rl20I

            // Learned: es5 doesn't allow variable property names in object literals, es6 does with ComputedPropertyNames (dem square brackets doh)
            mockedDataAccess.GetSettings = () => { return { [word] : definition }; }

            let div = document.createElement("div");
            let span = document.createElement("span");

            span.innerHTML = `bla bla bla ${word} bla bla bla`;

            div.appendChild(span);
            document.body.appendChild(div);

            // act
            sut.ApplySettings();

            // assert
            expect(span.innerHTML).toEqual(`bla bla bla ${definition} bla bla bla`);

            div.remove();
        });

        it("the plugin will automatically modify ajaxed content", function(){

            // use a mutation observer https://goo.gl/iBc25q

            // arrange (copied from above)
            let word = 'fire ants'; 
            let definition = 'spicy boys'; 

            mockedDataAccess.GetSettings = () => { return { [word] : definition }; }

            let div = document.createElement("div");
            let span = document.createElement("span");

            span.innerHTML = `bla bla bla ${word} bla bla bla`;

            div.appendChild(span);
            document.body.appendChild(div);

            // act
            sut.ApplySettings();

            // BOOM the dom was changed AFTER the plugin ran...
            span.innerHTML = `bla bla bla ${word} bla bla bla`;

            // assert
            expect(span.innerHTML).toEqual(`bla bla bla ${definition} bla bla bla`);

            div.remove();            
        });
    });    

    class SettingsDataAccess
    {
        constructor()
        {            
            this.storageKey = "WRP";
            this.defaultSettings = { "donald trump" : "mad scientist" }; 
        }

        GetSettings()
        {
            let settings = localStorage.getItem(this.storageKey);

            try
            {                
                let parsed = JSON.parse(settings); 
                if (parsed && typeof parsed === 'object') return parsed;                
            }
            catch(error)
            {
                console.error(`${error.message} while parsing: ${settings}`);
            }

            return this.defaultSettings; 
        }

        UpdateSettings(settings)
        {
            localStorage.setItem("WRP", JSON.stringify(settings));
        }
    }

    describe("When using the settings data access class... ", function(){

        let sut;
        beforeEach(() => { sut = new SettingsDataAccess(); });

        it("user settings will be returned if available", function(){
            // arrange
            let expectedSettings = { "this word" : "that word" };
            localStorage.setItem("WRP", JSON.stringify(expectedSettings));
            // act 
            let actualSettings = sut.GetSettings();
            // assert
            expect(actualSettings).toEqual(expectedSettings); 
        });

        it("default settings will be returned if user settings are empty", function(){
            // arrange
            localStorage.setItem("WRP", '');
            // act 
            let result = sut.GetSettings();
            // assert
            expect(result).toEqual( {"donald trump" : "mad scientist"} ); 
        });

        it("default settings will be returned if user settings are null", function(){
            // arrange
            localStorage.setItem("WRP", null);
            // act 
            let result = sut.GetSettings();
            // assert
            expect(result).toEqual( {"donald trump" : "mad scientist"} ); 
        });

        it("default settings will be returned if user settings are invalid json", function(){
            // arrange
            localStorage.setItem("WRP", '{');
            // act 
            let result = sut.GetSettings();
            // assert
            expect(result).toEqual( {"donald trump" : "mad scientist"} ); 
        });

        it("default settings will be returned if user settings not a JSON object", function(){
            // arrange
            localStorage.setItem("WRP", 9);
            // act 
            let result = sut.GetSettings();
            // assert
            expect(result).toEqual( {"donald trump" : "mad scientist"} ); 
        });        
    });    

</script>

</body>

</html>